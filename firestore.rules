rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to get user document
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Helper function to get user role in lowercase for case-insensitive comparison
    function getUserRole() {
      return getUserData().role.lower();
    }
    
    // Helper function to check if user has a specific role (case-insensitive)
    function hasRole(role) {
      return isAuthenticated() && getUserRole() == role.lower();
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return hasRole('admin');
    }

    // Helper function to check if user is top manager
    function isTopManager() {
      return hasRole('top management');
    }

    // Helper function to check if user is project manager
    function isProjectManager() {
      return hasRole('project manager');
    }

    // Helper function to check if user is project coordinator
    function isCoordinator() {
      return hasRole('project coordinator');
    }
    
    // Helper function to check if user is health practitioner
    function isPractitioner() {
      return hasRole('health practitioner');
    }
    
    // Helper function to check if user is client
    function isClient() {
      return hasRole('client');
    }
    
    // Helper function to check if user has staff role (admin, management, coordinator or healthcare practitioner)
    function isStaff() {
      return isAdmin() || isTopManager() || isProjectManager() || isCoordinator() || isPractitioner();
    }

      // Helper function to check if user has management role (admin, top manager, or project manager)
    function isManagement() {
      return isAdmin() || isTopManager() || isProjectManager();
    }

    // Users collection - Role-based access
    match /users/{userId} {
      // Anyone authenticated can read their own user document
      allow read: if isAuthenticated() && request.auth.uid == userId;
      
      // Only management can read all users
      allow list: if isAuthenticated() && isManagement();
      
      // Allow users to create their own document during registration
      // OR Management can create any user document
      allow create: if (isAuthenticated() && request.auth.uid == userId) || isManagement();
      
      // Users can update their own profile (except role field)
      // Management can update any user
      allow update: if (isAuthenticated() && request.auth.uid == userId && 
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role'])) 
                    || isManagement();
      
      // Only Management can delete users
      allow delete: if isAuthenticated() && isManagement();
    }

    //User Events collection - Management allocates, staff views own events
     match /user_events/{document} {
      // Allow read operations (get, list, and real-time listeners via snapshots())
      // This allows authenticated users to read documents
      // App-level filtering ensures users only see their own events
      allow read: if isAuthenticated();
      
      // Management can allocate events to users (create)
      allow create: if isAuthenticated() && isManagement();
      
      // Management can update event allocations
      allow update: if isAuthenticated() && isManagement();
      
      // Management can delete event allocations
      allow delete: if isAuthenticated() && isManagement();
    }
    
    // Events collection - Staff can manage, authenticated can read
    match /events/{eventId} {
      // All authenticated users who are staff members can read events
      allow read: if isAuthenticated() && isStaff();
      
      // Only management (admin, top manager and project manager) can create events
      allow create: if isAuthenticated() && isManagement();
      
      // Only management can update events
      allow update: if isAuthenticated() && isManagement();
      
      // Only management can delete events
      allow delete: if isAuthenticated() && isManagement();
    }
    
    // Wellness Sessions collection - Staff can create/read/update
    match /wellness_sessions/{sessionId} {
      // Staff can read all sessions
      // Authenticated users can only read their own sessions
      allow read: if isStaff() || 
                    (isAuthenticated() && resource.data.userId == request.auth.uid);
      
      // Only staff can create wellness sessions
      allow create: if isAuthenticated() && isStaff();
      
      // Only staff can update sessions
      allow update: if isAuthenticated() && isStaff();
      
      // Only management can delete sessions
      allow delete: if isAuthenticated() && isManagement();
    }
    
    // Participants/Members collection - Staff can manage
    match /participants/{participantId} {
      // Staff can read all participants
      allow read: if isAuthenticated() && isStaff();
      
      // Staff can create participants
      allow create: if isAuthenticated() && isStaff();
      
      // Staff can update participants
      allow update: if isAuthenticated() && isStaff();
      
      // Only management can delete participants
      allow delete: if isAuthenticated() && isManagement();
    }
    
    // Members collection - Staff can manage
    match /members/{memberId} {
      // Staff can read all members
      allow read: if isAuthenticated() && isStaff();
      
      // Staff can create members
      allow create: if isAuthenticated() && isStaff();
      
      // Staff can update members
      allow update: if isAuthenticated() && isStaff();
      
      // Only management can delete members
      allow delete: if isAuthenticated() && isManagement();
    }
    
    // Consents collection - Staff can manage
    match /consents/{consentId} {
      // Staff can read all consents
      allow read: if isAuthenticated() && isStaff();
      
      // Staff can create consents
      allow create: if isAuthenticated() && isStaff();
      
      // Staff can update consents
      allow update: if isAuthenticated() && isStaff();
      
      // Only management can delete consents
      allow delete: if isAuthenticated() && isManagement();
    }
    
    // HRA Screenings collection - Staff can manage
    match /hra_screenings/{screeningId} {
      // Staff can read all HRA screenings
      allow read: if isAuthenticated() && isStaff();
      
      // Staff can create HRA screenings
      allow create: if isAuthenticated() && isStaff();
      
      // Staff can update HRA screenings
      allow update: if isAuthenticated() && isStaff();
      
      // Only management can delete HRA screenings
      allow delete: if isAuthenticated() && isManagement();
    }
    
    // HIV Screenings collection - Staff can manage
    match /hiv_screenings/{screeningId} {
      // Staff can read all HIV screenings
      allow read: if isAuthenticated() && isStaff();
      
      // Staff can create HIV screenings
      allow create: if isAuthenticated() && isStaff();
      
      // HIV can update HIV screenings
      allow update: if isAuthenticated() && isStaff();
      
      // Only management can delete HIV screenings
      allow delete: if isAuthenticated() && isManagement();
    }
    
    // HIV Results collection - Staff can manage
    match /hiv_results/{resultId} {
      // Staff can read all HIV results
      allow read: if isAuthenticated() && isStaff();
      
      // Staff can create HIV results
      allow create: if isAuthenticated() && isStaff();
      
      // Staff can update HIV results
      allow update: if isAuthenticated() && isStaff();
      
      // Only management can delete HIV results
      allow delete: if isAuthenticated() && isManagement();
    }
    
    // TB Screenings collection - Staff can manage
    match /tb_screenings/{screeningId} {
      // Staff can read all TB screenings
      allow read: if isAuthenticated() && isStaff();
      
      // Staff can create TB screenings
      allow create: if isAuthenticated() && isStaff();
      
      // Staff can update TB screenings
      allow update: if isAuthenticated() && isStaff();
      
      // Only management can delete TB screenings
      allow delete: if isAuthenticated() && isManagement();
    }
    
    // Survey results collection - Staff can read, system can write
    match /survey_results/{resultId} {
      // Staff can read survey results
      allow read: if isAuthenticated() && isStaff();
      
      // Staff can create survey results
      allow create: if isAuthenticated() && isStaff();
      
      // Staff can update survey results
      allow update: if isAuthenticated() && isStaff();
      
      // Only management can delete survey results
      allow delete: if isAuthenticated() && isManagement();
    }
    
    // Screening results (HIV, TB, HRA) - Staff only
    match /screening_results/{resultId} {
      // Only staff can access screening results (sensitive health data)
      allow read: if isAuthenticated() && isStaff();
      
      // Only staff can create screening results
      allow create: if isAuthenticated() && isStaff();
      
      // Only staff can update screening results
      allow update: if isAuthenticated() && isStaff();
      
      // Only management can delete screening results
      allow delete: if isAuthenticated() && isManagement();
    }
    
    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
